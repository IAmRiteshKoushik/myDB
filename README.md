# Database Development

## Preliminary Notes

### 1. Persistence
A database will recover to a usable state when started after an unexpected
shutdown. While we can achieve it without a database as follows:

- Write the whole updated dataset to a file
- Call `fsync` on the new file
- Overwrite the old file by renaming the new file to the old file, which is 
guarenteed by the file-systems to be atomic.

But this is only acceptable with a tiny dataset. Databases can do incremental 
updates.

### 2. Indexing
There are two distinct types of database queries: analytical (OLAP) and 
transactional (OLTP).

- Analytical (OLAP) queries typically involve a large amount of data, with 
aggregation, grouping or join operations
- In contrast, transactional (OLTP) queries usually only touch a small amount 
of indexed data. The most common types of queres are indexed point queries 
and indexed range queries.

> Data structures that persist on disk to `look up` data are called `indexes`
in database systems. And database indexes can be larger than memory. 

Common data structures include `B-Trees` and `LSM-Trees`

### 3. Concurrency
Modern applications do not do everything sequentially, and nor do databases.
There are different levels to concurrency :

- Concurrency between readers
- Concurrency between readers and writers
- Do writers need exclusive access to the database ?

## Understanding SQLite
1. Tokenizer (frontend)
2. Parser (frontend)
3. Code Generator (frontend)

> The frontend input is an SQL query. The output is SQLite virtual machine 
bytecode
    
4. Virtual Machine (backend) takes bytecode generated by the front-end as 
instructions.It can the perform operations on one or more tables or 
indexes, each of which is stored in a data-structure called a B-tree. The 
VM is essentially a big switch statement on the type of bytecode instruction.
5. B-Tree (backend) consists of amny nodes. Each node is one page in length. The 
B-tree can retrieve a page from the disk or save it back to disk by issuing 
commands to the pager.
6. Pager (backend) receives commands to read or write pages of data. It is 
responsible for reading/writing at appropriate offsets in the database file. It 
also keeps a cache of recently accessed pages in memory, and determines when 
those pages need to be written back to disk.
7. OS Interface (backend) is the layer that differs on which operating system 
SQLite was compiled for.

### Building an In-Memory, Append Only, Single-Table Database

Current things to support :
1. Support two operations : Inserting a row and printing all rows
2. Reside only in-memory (no presistance to disk)
3. Support a single, hard-coded table

Hard-coded table structure
{
  id: integer,
  username: varchar(32),
  email: varchar(255)
}


